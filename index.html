<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>æ¥µé€Ÿå–®å­—æŒ‘æˆ° - æš´èµ°å…¬è·¯</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Noto+Sans+TC:wght@400;700&family=Russo+One&display=swap');

    body {
      font-family: 'Noto Sans TC', sans-serif;
      background: #050505;
      color: white;
      /* ä½¿ç”¨ dvh (dynamic viewport height) è§£æ±ºæ‰‹æ©Ÿç€è¦½å™¨ç¶²å€åˆ—é®æ“‹å•é¡Œ */
      height: 100vh;
      height: 100dvh; 
      overflow: hidden;
      display: flex;
      align-items: center;
      justify-content: center;
      user-select: none;
      overscroll-behavior: none;
    }

    .game-font { font-family: 'Russo One', sans-serif; }

    /* --- éŠæˆ²ä¸»æ¡†æ¶ (é è¨­é›»è…¦ç‰ˆï¼šå·¦å³é…ç½®) --- */
    .main-grid {
      display: grid;
      grid-template-columns: 3fr 1fr; /* å·¦3å³1 */
      grid-template-rows: 100%;       /* é«˜åº¦æ»¿ */
      width: 98%; max-width: 1400px;
      height: 95vh; max-height: 900px;
      background: #1e1e24;
      border-radius: 12px;
      box-shadow: 0 0 50px rgba(0,0,0,1);
      overflow: hidden;
      border: 1px solid #333;
    }

    /* --- æ‰‹æ©Ÿ/çª„è¢å¹•ç‰ˆï¼šä¸Šä¸‹é…ç½® --- */
    @media (max-width: 768px) {
      .main-grid {
        grid-template-columns: 1fr;      /* å–®æ¬„ */
        /* èª¿æ•´æ¯”ä¾‹ï¼šå ´æ™¯55%ï¼Œå„€è¡¨æ¿45%ï¼Œçµ¦ä¸‹æ–¹æ›´å¤šç©ºé–“ */
        grid-template-rows: 55% 45%;     
        width: 100%;
        height: 100%; /* è·Ÿéš¨ body é«˜åº¦ */
        max-height: none;
        border-radius: 0;
        border: none;
      }
      
      /* æ‰‹æ©Ÿç‰ˆç§»é™¤åœ“è§’èˆ‡å³é‚Šæ¡†ï¼Œæ”¹ç‚ºä¸‹é‚Šæ¡†åˆ†éš” */
      .track-panel {
        border-right: none !important;
        border-bottom: 2px solid #333;
      }
      
      .dashboard-panel {
        border-left: none !important;
        /* å¢åŠ åº•éƒ¨ padding (pb-8) é¿å…æ‰‹æ©Ÿåº•éƒ¨æ©«æ¢é®æ“‹ */
        padding: 10px 10px 30px 10px !important; 
        overflow-y: auto; /* é é˜²å…§å®¹çœŸçš„å¤ªå¤šæ™‚å¯ä»¥æ»‘å‹• */
      }

      /* èª¿æ•´æ‰‹æ©Ÿç‰ˆå­—é«”å¤§å°ï¼Œé¿å…å¤ªæ“  */
      .dashboard-panel h1 { font-size: 1.2rem; }
      .question-card h2 { font-size: 1.5rem; }
      .question-card { padding: 8px; margin-bottom: 10px; }
      
      /* æ‰‹æ©Ÿç‰ˆå–®å­—å¡ç¸®å°ï¼Œé¿å…é‡ç–Š */
      .word-item { font-size: 16px !important; padding: 4px 10px !important; }

      /* éš±è—éƒ¨åˆ†ä¸å¿…è¦çš„æç¤ºä»¥ç¯€çœç©ºé–“ */
      .controls-hint { display: none !important; }
      
      /* èª¿æ•´é–‹å§‹/çµæŸç•«é¢çš„å…§å®¹å¤§å° */
      #startScreen .text-5xl { font-size: 3rem; }
      #startScreen h2 { font-size: 1.2rem; }
      #startScreen p { font-size: 0.75rem; display: none; } /* æ‰‹æ©Ÿç‰ˆéš±è—è½è½é•·çš„èªªæ˜ */
    }

    /* --- è³½é“å ´æ™¯ (å·¦å´/ä¸Šå´) --- */
    .track-panel {
      position: relative;
      background: #1a2a3a; 
      overflow: hidden;
      perspective: 800px; 
      border-right: 4px solid #111;
      cursor: crosshair; 
      touch-action: none; 
      width: 100%;
      height: 100%;
    }

    .input-layer {
      position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 200;
    }

    .scene-container {
      position: absolute;
      top: 0; left: 0; width: 100%; height: 100%;
      transform-style: preserve-3d;
      z-index: 2;
    }

    /* é“è·¯å®¹å™¨ */
    .road-container {
      position: absolute;
      top: -150%; 
      left: -50%; 
      width: 200%; 
      height: 400%;
      transform-origin: 50% 100%;
      transform: rotateX(25deg);
      transition: transform 1s ease-out;
    }

    /* é“è·¯ç´‹ç† */
    .road {
      width: 100%; height: 100%;
      background-color: #555;
      background-image: 
        linear-gradient(to right, transparent 49%, #facc15 49%, #facc15 50%, transparent 50%, transparent 51%, #facc15 51%, #facc15 52%, transparent 52%),
        linear-gradient(to right, transparent 15%, #fff 15%, #fff 16%, transparent 16%, transparent 84%, #fff 84%, #fff 85%, transparent 85%),
        linear-gradient(to right, #4ade80 0%, #15803d 15%, transparent 15%, transparent 85%, #15803d 85%, #4ade80 100%),
        repeating-linear-gradient(180deg, transparent 0, transparent 40px, rgba(255,255,255,0.05) 40px, rgba(255,255,255,0.05) 80px);
        
      background-size: 100% 100%, 100% 100%, 100% 100%, 100% 200px;
      animation: roadScroll 0.3s linear infinite;
      box-shadow: inset 0 0 100px rgba(0,0,0,0.5);
    }

    @keyframes roadScroll {
      from { background-position: 0 0, 0 0, 0 0, 0 0; }
      to { background-position: 0 0, 0 0, 0 0, 0 200px; }
    }

    /* --- å¯¦é«”ç³»çµ± --- */
    .game-object {
      position: absolute;
      transform-style: preserve-3d;
      display: flex; justify-content: center; align-items: center;
      will-change: transform, top, left;
    }

    #playerCar {
      width: 70px; height: 120px;
      left: 50%; 
      margin-left: -35px;
      z-index: 100;
      transition: transform 0.1s; 
      pointer-events: none;
    }

    /* å–®å­—é“å…· */
    .word-item {
      color: #000;
      background: #ffffff;
      font-weight: 900;
      font-size: 20px; /* ç¨å¾®èª¿å°å­—é«”ä»¥é©æ‡‰é•·å–®å­— */
      padding: 6px 12px;
      border-radius: 8px;
      border: 3px solid #333;
      z-index: 60;
      animation: floatWord 0.5s ease-in-out infinite alternate;
      white-space: nowrap;
      box-shadow: 0 5px 15px rgba(0,0,0,0.5);
    }
    
    @keyframes floatWord {
      from { transform: translateY(0) scale(1); }
      to { transform: translateY(-5px) scale(1.1); }
    }

    /* äº¤é€šè»Šè¼› */
    .traffic-car { 
      width: 70px; height: 120px;
      z-index: 50; 
      transition: transform 0.2s; 
    }

    /* ç ²å½ˆæ¨£å¼ */
    .projectile {
      width: 14px; height: 14px;
      background: radial-gradient(circle, #ffeb3b 20%, #ff0000 80%);
      border-radius: 50%;
      box-shadow: 0 0 10px #ff0000, 0 0 20px #ff8800;
      z-index: 55;
    }

    /* è»Šé«”ç¹ªè£½ */
    .car-body {
      width: 100%; height: 100%;
      position: relative;
      filter: drop-shadow(0 10px 10px rgba(0,0,0,0.6));
    }
    
    .car-img {
      width: 100%; 
      height: 100%; 
      object-fit: contain;
      position: relative;
      z-index: 2;
    }

    .fallback-rect {
      display: none;
      width: 48px; 
      height: 90px;
      border-radius: 8px;
      margin: 0 auto;
      position: absolute;
      top: 15px; left: 11px;
      z-index: 1;
      border: 2px solid rgba(0,0,0,0.5);
    }
    
    /* åŠ é€Ÿç«å…‰ */
    .boost-fire {
      position: absolute; 
      bottom: -10px; 
      left: 50%; 
      transform: translateX(-50%);
      width: 20px; height: 40px;
      background: linear-gradient(to bottom, #3b82f6, transparent);
      opacity: 0; 
      transition: opacity 0.2s;
      z-index: 0;
    }
    .boosting .boost-fire { opacity: 1; }

    .player-hit .car-body { animation: damageFlash 0.2s ease-in-out 3; }
    @keyframes damageFlash {
      0%, 100% { filter: drop-shadow(0 10px 10px rgba(0,0,0,0.6)); }
      50% { filter: sepia(1) hue-rotate(-50deg) saturate(3) drop-shadow(0 0 10px red); }
    }

    .shake-screen { animation: shake 0.4s cubic-bezier(.36,.07,.19,.97) both; }
    @keyframes shake { 
      10%, 90% { transform: translate3d(-3px, 0, 0); }
      20%, 80% { transform: translate3d(5px, 0, 0); }
      30%, 50%, 70% { transform: translate3d(-7px, 0, 0); }
      40%, 60% { transform: translate3d(7px, 0, 0); }
    }

    .anim-collect { animation: collectFly 0.5s ease-out forwards; }
    @keyframes collectFly {
      0% { transform: scale(1); opacity: 1; }
      100% { transform: scale(2) translateY(-100px); opacity: 0; }
    }

    .anim-flip-crash { animation: flipOver 0.6s ease-out forwards; }
    @keyframes flipOver {
      0% { transform: translate3d(0, 0, 0) rotate(0deg); opacity: 1; }
      100% { transform: translate3d(300px, -400px, 100px) rotate(720deg) scale(0.5); opacity: 0; }
    }
    .anim-flip-crash-left { animation: flipOverLeft 0.6s ease-out forwards; }
    @keyframes flipOverLeft {
      0% { transform: translate3d(0, 0, 0) rotate(0deg); opacity: 1; }
      100% { transform: translate3d(-300px, -400px, 100px) rotate(-720deg) scale(0.5); opacity: 0; }
    }

    /* --- UI --- */
    .dashboard-panel {
      padding: 20px; background: #111;
      display: flex; flex-direction: column;
      position: relative;
      border-left: 2px solid #333;
    }
    .heart { font-size: 20px; color: #ef4444; margin: 0 1px; }
    .heart.lost { color: #444; }
    
    .question-card {
      background: #1f2937; border-left: 4px solid #facc15;
      padding: 12px; margin-bottom: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.5);
      text-align: center;
    }

    .controls-hint {
      display: flex; justify-content: center; gap: 10px; margin-top: 20px; flex-wrap: wrap;
    }
    .key-hint {
      display: flex; justify-content: center; align-items: center;
      padding: 10px 20px;
      background: #333; border-radius: 8px; border-bottom: 4px solid #111;
      color: #aaa; font-size: 14px;
    }
    .icon-mouse { font-size: 24px; margin-right: 8px; }
  </style>
</head>
<body>

  <div class="main-grid">
    <!-- å·¦å´(æ‰‹æ©Ÿç‚ºä¸Šå´) å ´æ™¯ -->
    <div class="track-panel" id="trackPanel">
      <div class="input-layer" id="inputLayer"></div>

      <div class="scene-container">
        <div class="road-container" id="roadContainer">
          <div class="road" id="road"></div>
        </div>
      </div>
      
      <div id="gameEntities"></div>

      <div class="game-object" id="playerCar">
        <div class="car-body">
          <img src="player.png" class="car-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
          <div class="fallback-rect bg-yellow-500"></div>
          <div class="boost-fire"></div>
        </div>
        <div class="absolute -bottom-8 text-[10px] font-bold text-yellow-400 tracking-wider bg-black bg-opacity-70 px-2 rounded">YOU</div>
      </div>
    </div>

    <!-- å³å´(æ‰‹æ©Ÿç‚ºä¸‹å´) é¢æ¿ -->
    <div class="dashboard-panel">
      <div class="flex justify-between items-center mb-6 border-b border-gray-800 pb-4">
        <div>
          <h1 class="text-xl md:text-2xl text-yellow-500 game-font italic transform -skew-x-12">TURBO<br>DRIVER</h1>
        </div>
        <div class="text-right">
          <div id="healthBar" class="mb-1 flex"></div>
          <div class="text-[10px] text-gray-500 uppercase tracking-widest">SCORE</div>
          <div class="text-xl font-mono text-blue-400" id="scoreDisplay">0</div>
        </div>
      </div>

      <div class="flex-grow relative">
        <div id="startScreen" class="absolute inset-0 z-20 flex flex-col items-center justify-center text-center">
          <div class="text-5xl mb-4 animate-bounce">ğŸš—ğŸ’¨</div>
          <h2 class="text-lg font-bold mb-2 text-white">æ¥µé€ŸæŒ‘æˆ°</h2>
          <p class="text-gray-400 text-xs mb-6 px-4">
            <span class="text-yellow-400">ğŸ–±ï¸ æ»‘é¼ </span> / <span class="text-yellow-400">ğŸ‘† è§¸æ§</span><br>
            æ§åˆ¶è»Šè¼›å…¨æ–¹ä½ç§»å‹•<br>
            <br>
            è’é›†æ­£ç¢ºå–®å­—ï¼Œèº²é¿ç ²å½ˆï¼
          </p>
          <button onclick="startGame()" class="game-font w-full bg-gradient-to-r from-blue-600 to-blue-500 hover:from-blue-500 hover:to-blue-400 text-white text-lg py-3 rounded-lg shadow-lg transform transition hover:scale-105">
            START
          </button>
        </div>

        <div id="resultScreen" class="hidden absolute inset-0 z-20 flex flex-col items-center justify-center text-center bg-gray-900 bg-opacity-95 rounded-xl">
          <div class="text-6xl mb-4" id="resultEmoji">ğŸ’¥</div>
          <h2 class="text-2xl font-bold mb-2 text-white game-font" id="resultTitle">GAME OVER</h2>
          <p class="text-gray-400 mb-6 text-sm" id="resultDesc">...</p>
          <button onclick="startGame()" class="w-full bg-blue-600 hover:bg-blue-500 text-white font-bold py-3 rounded-lg shadow-lg">
            TRY AGAIN
          </button>
        </div>

        <div id="questionArea" class="hidden flex flex-col h-full items-center pt-2 md:pt-4">
          <div class="text-gray-400 text-[10px] uppercase mb-1">TRANSLATE</div>
          <div class="question-card w-full">
            <h2 id="qText" class="text-2xl md:text-3xl font-bold text-white leading-tight">...</h2>
          </div>
          
          <div id="feedback" class="h-8 mt-2 text-center font-bold text-sm tracking-wider"></div>

          <div class="controls-hint">
            <div class="key-hint"><span class="icon-mouse">ğŸ–±ï¸</span> æ»‘é¼ </div>
            <div class="key-hint"><span class="icon-mouse">ğŸ‘†</span> è§¸æ§</div>
          </div>
          <div class="text-[10px] text-gray-600 mt-2 text-center hidden md:block">æ¸¸æ¨™/æ‰‹æŒ‡å³ç‚ºè»Šè¼›ä½ç½®</div>
        </div>
      </div>

      <div class="mt-auto pt-4">
        <div class="flex justify-between text-[10px] text-gray-500 mb-1 font-mono">
          <span>PROGRESS</span>
          <span id="progressText">0%</span>
        </div>
        <div class="w-full bg-gray-800 h-2 rounded-full overflow-hidden">
          <div id="progressBar" class="bg-blue-500 h-full w-0 transition-all duration-300"></div>
        </div>
      </div>
    </div>
  </div>

  <script>
    // æ ¹æ“šä½¿ç”¨è€…è¦æ±‚æ›´æ–°å–®å­—åº«
    const questionsData = [
      { zh: "è¥¯è¡«", en: "shirt" },
      { zh: "æ´‹è£", en: "dress" },
      { zh: "å¥³ç”¨è¥¯è¡«", en: "a blouse" },
      { zh: "é«˜é ˜", en: "turtleneck" },
      { zh: "å¤¾å…‹", en: "jacket" },
      { zh: "å¤–å¥—", en: "coat" },
      { zh: "çŸ­è¤²", en: "shorts" },
      { zh: "çŸ­è¡£", en: "T-shirt" },
      { zh: "æ¯›è¡£", en: "sweater" },
      { zh: "é«’äº‚çš„", en: "messy" },
      { zh: "ä¸Ÿæ£„", en: "throw away" },
      { zh: "çŸ­è¢–è¥¯è¡«", en: "short-sleeved shirt" },
      { zh: "æ›è‘—", en: "hang" },
      { zh: "è¡£æ«¥", en: "closet" },
      { zh: "é‡ç·šåŒ…", en: "sewing kit" },
      { zh: "å®‰å…¨åˆ¥é‡", en: "safety pin" },
      { zh: "æŸé«®å¸¶", en: "hair bands" },
      { zh: "ç´ ææœ¬", en: "sketchbook" },
      { zh: "å……é›»å™¨", en: "charger" }
    ];
    
    const allWords = questionsData.map(q => q.en);
    const MAX_LIVES = 2; // ç”Ÿå‘½å€¼è¨­å®šç‚ºå…©æ¢
    const TRAFFIC_LATERAL_SPEED = 0.2; 
    const BULLET_SPEED = 8; 
    
    // éŠæˆ²é‚Šç•Œ
    const BOUNDS_X_MIN = 10;
    const BOUNDS_X_MAX = 90;
    const BOUNDS_Y_MIN = 5;
    const BOUNDS_Y_MAX = 90;

    const LANES = [20, 50, 80];

    const CAR_IMAGES = ['play1.png', 'play2.png', 'play3.png', 'play4.png', 'play5.png'];
    const FALLBACK_COLORS = ['bg-red-500', 'bg-blue-500', 'bg-green-500', 'bg-gray-500', 'bg-purple-500'];

    let gameState = {
      queue: [],
      currentIdx: 0,
      score: 0,
      mistakes: 0,
      isRunning: false,
      gameLoop: null,
      spawnerLoop: null,
      playerX: 50, 
      playerY: 10,
      lastHitTime: 0,
      lastPlayerX: 50,
      currentTilt: 0,
    };

    let keys = { ArrowLeft: false, ArrowRight: false, ArrowUp: false, ArrowDown: false };

    const ui = {
      startScreen: document.getElementById('startScreen'),
      questionArea: document.getElementById('questionArea'),
      resultScreen: document.getElementById('resultScreen'),
      qText: document.getElementById('qText'),
      feedback: document.getElementById('feedback'),
      scoreDisplay: document.getElementById('scoreDisplay'),
      progressBar: document.getElementById('progressBar'),
      progressText: document.getElementById('progressText'),
      healthBar: document.getElementById('healthBar'),
      resultTitle: document.getElementById('resultTitle'),
      resultDesc: document.getElementById('resultDesc'),
      resultEmoji: document.getElementById('resultEmoji'),
      
      trackPanel: document.getElementById('trackPanel'),
      playerCar: document.getElementById('playerCar'),
      gameEntities: document.getElementById('gameEntities'),
      inputLayer: document.getElementById('inputLayer')
    };

    function shuffle(arr) { return arr.sort(() => Math.random() - 0.5); }

    /* --- æ“æ§è¼¸å…¥è™•ç† --- */
    window.addEventListener('mousemove', (e) => {
      if (!gameState.isRunning) return;
      handleInputMove(e.clientX, e.clientY);
    });

    window.addEventListener('touchmove', (e) => {
      if (!gameState.isRunning) return;
      const touch = e.touches[0];
      handleInputMove(touch.clientX, touch.clientY);
    }, {passive: false});

    window.addEventListener('touchstart', (e) => {
       if (gameState.isRunning && e.target.closest('.track-panel')) {
       }
    }, {passive: false});

    function handleInputMove(clientX, clientY) {
      const rect = ui.trackPanel.getBoundingClientRect();
      
      let rawX = (clientX - rect.left) / rect.width * 100;
      let rawY = (1 - (clientY - rect.top) / rect.height) * 100;

      let targetX = Math.max(BOUNDS_X_MIN, Math.min(rawX, BOUNDS_X_MAX));
      let targetY = Math.max(BOUNDS_Y_MIN, Math.min(rawY, BOUNDS_Y_MAX));

      gameState.playerX = targetX;
      gameState.playerY = targetY;
      
      ui.playerCar.style.left = gameState.playerX + '%';
      ui.playerCar.style.bottom = gameState.playerY + '%';
    }

    const KEY_SPEED_X = 2.0;
    const KEY_SPEED_Y = 1.5;
    
    document.addEventListener('keydown', (e) => {
      if (keys.hasOwnProperty(e.key)) keys[e.key] = true;
    });
    document.addEventListener('keyup', (e) => {
      if (keys.hasOwnProperty(e.key)) keys[e.key] = false;
    });

    // --- éŠæˆ²æµç¨‹ ---
    function startGame() {
      gameState.queue = shuffle([...questionsData]);
      gameState.currentIdx = 0;
      gameState.score = 0;
      gameState.mistakes = 0;
      gameState.isRunning = true;
      gameState.playerX = 50;
      gameState.playerY = 10;
      gameState.lastPlayerX = 50;
      gameState.currentTilt = 0;
      gameState.lastHitTime = 0;

      ui.scoreDisplay.innerText = "0";
      ui.progressBar.style.width = "0%";
      ui.progressText.innerText = "0%";
      updateHearts();
      
      ui.startScreen.classList.add('hidden');
      ui.resultScreen.classList.add('hidden');
      ui.questionArea.classList.remove('hidden');
      ui.trackPanel.style.cursor = 'crosshair'; 

      ui.gameEntities.innerHTML = "";
      ui.playerCar.classList.remove('player-hit');
      
      if (gameState.gameLoop) cancelAnimationFrame(gameState.gameLoop);
      if (gameState.spawnerLoop) clearInterval(gameState.spawnerLoop);

      gameState.spawnerLoop = setInterval(spawnManager, 1200);
      gameState.gameLoop = requestAnimationFrame(updateGame);

      showNextQuestion();
    }

    function updateHearts() {
      ui.healthBar.innerHTML = "";
      const remaining = MAX_LIVES - gameState.mistakes;
      for (let i = 0; i < MAX_LIVES; i++) {
        const span = document.createElement('span');
        span.className = `heart ${i < remaining ? '' : 'lost'}`;
        span.innerText = i < remaining ? 'â¤ï¸' : 'ğŸ’”';
        ui.healthBar.appendChild(span);
      }
    }

    function showNextQuestion() {
      if (gameState.currentIdx >= gameState.queue.length) {
        endGame(true);
        return;
      }
      const q = gameState.queue[gameState.currentIdx];
      ui.qText.innerText = q.zh;
      ui.feedback.innerText = "";
      
      const pct = Math.round((gameState.currentIdx / gameState.queue.length) * 100);
      ui.progressBar.style.width = `${pct}%`;
      ui.progressText.innerText = `${pct}%`;
    }

    // --- éŠæˆ²ä¸»è¿´åœˆ ---
    function updateGame() {
      if (!gameState.isRunning) return;

      if (keys.ArrowLeft) gameState.playerX -= KEY_SPEED_X;
      if (keys.ArrowRight) gameState.playerX += KEY_SPEED_X;
      if (keys.ArrowUp) gameState.playerY += KEY_SPEED_Y;
      if (keys.ArrowDown) gameState.playerY -= KEY_SPEED_Y;

      if (gameState.playerX < BOUNDS_X_MIN) gameState.playerX = BOUNDS_X_MIN;
      if (gameState.playerX > BOUNDS_X_MAX) gameState.playerX = BOUNDS_X_MAX;
      if (gameState.playerY < BOUNDS_Y_MIN) gameState.playerY = BOUNDS_Y_MIN;
      if (gameState.playerY > BOUNDS_Y_MAX) gameState.playerY = BOUNDS_Y_MAX;

      ui.playerCar.style.left = gameState.playerX + '%';
      ui.playerCar.style.bottom = gameState.playerY + '%';

      const deltaX = gameState.playerX - gameState.lastPlayerX;
      let targetTilt = deltaX * 2.5; 
      if (targetTilt > 25) targetTilt = 25;
      if (targetTilt < -25) targetTilt = -25;
      
      gameState.currentTilt += (targetTilt - gameState.currentTilt) * 0.2;
      ui.playerCar.style.transform = `rotate(${gameState.currentTilt}deg)`;
      
      gameState.lastPlayerX = gameState.playerX;

      updateEntities();

      gameState.gameLoop = requestAnimationFrame(updateGame);
    }

    function updateEntities() {
      const entities = document.querySelectorAll('.game-object:not(#playerCar)');
      const playerRect = ui.playerCar.getBoundingClientRect();
      const pRect = {
        left: playerRect.left + 15,
        right: playerRect.right - 15,
        top: playerRect.top + 15,
        bottom: playerRect.bottom - 15
      };

      entities.forEach(el => {
        let top = parseFloat(el.dataset.top || -150);
        let speed = parseFloat(el.dataset.speed || 0.5);
        
        // --- æ•µè»Šè¡Œç‚º ---
        if (el.dataset.type === 'car') {
            let currentLeft = parseFloat(el.style.left);
            const playerScreenY = window.innerHeight * (1 - gameState.playerY / 100);
            
            if (top < playerScreenY && top > 0) {
                if (currentLeft < gameState.playerX - 2) {
                    currentLeft += TRAFFIC_LATERAL_SPEED;
                    el.style.transform = `rotate(5deg)`;
                } else if (currentLeft > gameState.playerX + 2) {
                    currentLeft -= TRAFFIC_LATERAL_SPEED;
                    el.style.transform = `rotate(-5deg)`;
                } else {
                    el.style.transform = `rotate(0deg)`;
                }
                
                if (Math.random() < 0.015) { 
                    spawnBullet(el, top, currentLeft);
                }
            }
            if (currentLeft < 10) currentLeft = 10;
            if (currentLeft > 90) currentLeft = 90;
            el.style.left = currentLeft + '%';
        }

        top += speed;
        el.dataset.top = top;
        el.style.top = top + 'px';

        if (top > window.innerHeight) {
          el.remove();
          return;
        }

        if (el.dataset.hit === 'true') return;

        const eRect = el.getBoundingClientRect();
        if (
          pRect.left < eRect.right &&
          pRect.right > eRect.left &&
          pRect.top < eRect.bottom &&
          pRect.bottom > eRect.top
        ) {
          handleCollision(el);
        }
      });
    }

    function spawnBullet(sourceEl, top, leftPct) {
        if (sourceEl.dataset.bulletCooldown && parseInt(sourceEl.dataset.bulletCooldown) > 0) {
            sourceEl.dataset.bulletCooldown = parseInt(sourceEl.dataset.bulletCooldown) - 1;
            return;
        }
        sourceEl.dataset.bulletCooldown = 30;

        const bullet = document.createElement('div');
        bullet.className = "game-object projectile";
        bullet.dataset.type = "bullet";
        bullet.dataset.speed = BULLET_SPEED;
        bullet.style.left = leftPct + '%';
        bullet.dataset.top = top + 80;
        bullet.style.top = (top + 80) + 'px';
        
        ui.gameEntities.appendChild(bullet);
    }

    function handleCollision(el) {
      el.dataset.hit = "true";
      const type = el.dataset.type;

      if (type === 'car') {
        takeDamage("CRASH! æ’è»Š ğŸ’¥");
        el.classList.add(Math.random() > 0.5 ? 'anim-flip-crash' : 'anim-flip-crash-left');
      } else if (type === 'bullet') {
        takeDamage("HIT! ä¸­å½ˆ ğŸ”¥");
        el.remove(); 
      } else if (type === 'word') {
        const word = el.innerText;
        const correctWord = gameState.queue[gameState.currentIdx].en;
        
        if (word === correctWord) {
          gameState.score += 100;
          ui.scoreDisplay.innerText = gameState.score;
          ui.feedback.innerHTML = `<span class="text-green-400 drop-shadow-md">GET! ğŸ‰</span>`;
          ui.playerCar.classList.add('boosting');
          
          el.classList.add('anim-collect');
          setTimeout(() => el.remove(), 500);
          setTimeout(() => ui.playerCar.classList.remove('boosting'), 500);

          gameState.currentIdx++;
          document.querySelectorAll('[data-type="word"]').forEach(w => {
             if(w !== el) w.animate([{opacity:1}, {opacity:0}], {duration:200}).onfinish = () => w.remove();
          });
          
          setTimeout(showNextQuestion, 800);

        } else {
          // ä¿®æ”¹ï¼šè‹¥æ’åˆ°éŒ¯èª¤å–®å­—ï¼Œç¾åœ¨æœƒå¤±è¡€ï¼
          takeDamage(`WRONG! âŒ`);
          
          el.style.transform = "scale(0) rotate(360deg)";
          el.style.transition = "transform 0.5s";
          setTimeout(() => el.remove(), 500);
        }
      }
    }

    // åªæ™ƒå‹•è¢å¹•èˆ‡é¡¯ç¤ºè¨Šæ¯ (ä¸æ‰£è¡€ç”¨)
    function triggerShake(msg) {
      ui.feedback.innerHTML = `<span class="text-yellow-500 font-bold">${msg}</span>`;
      ui.trackPanel.classList.add('shake-screen');
      setTimeout(() => {
        ui.trackPanel.classList.remove('shake-screen');
      }, 500);
    }

    // æ‰£è¡€ä¸¦æ™ƒå‹•
    function takeDamage(msg) {
      const now = Date.now();
      if (now - gameState.lastHitTime < 1000) return;
      gameState.lastHitTime = now;

      gameState.mistakes++;
      updateHearts();
      ui.feedback.innerHTML = `<span class="text-red-500 font-bold">${msg}</span>`;
      
      ui.playerCar.classList.add('player-hit');
      ui.trackPanel.classList.add('shake-screen');

      setTimeout(() => {
        ui.trackPanel.classList.remove('shake-screen');
        ui.playerCar.classList.remove('player-hit');
      }, 500);

      if (gameState.mistakes >= MAX_LIVES) {
        setTimeout(() => endGame(false), 800);
      }
    }

    function isLaneFree(lanePos) {
      const entities = document.querySelectorAll('.game-object:not(#playerCar)');
      for (let el of entities) {
        const elLeft = parseFloat(el.style.left); 
        const elTop = parseFloat(el.dataset.top || -150);
        if (Math.abs(elLeft - lanePos) < 5) {
           if (elTop < 300) return false; 
        }
      }
      return true;
    }

    function spawnManager() {
      if (!gameState.isRunning) return;
      if (gameState.currentIdx >= gameState.queue.length) return;

      const activeWords = document.querySelectorAll('.game-object[data-type="word"]');
      const correctWord = gameState.queue[gameState.currentIdx].en;
      const hasCorrect = Array.from(activeWords).some(el => el.dataset.word === correctWord);

      const shuffledLanes = shuffle([...LANES]);
      const freeLanes = shuffledLanes.filter(lane => isLaneFree(lane));

      // è‹¥ç›®å‰æ²’æœ‰æ­£ç¢ºå–®å­—åœ¨å ´ä¸Šï¼Œä¸”æœ‰è¶³å¤ è»Šé“ç”Ÿæˆä¸€å° (æ­£ç¢º+éŒ¯èª¤)
      if (!hasCorrect && freeLanes.length >= 2) {
          // æé«˜å‡ºç¾æ©Ÿç‡ï¼Œç¢ºä¿ç©å®¶èƒ½é¸
          if (Math.random() < 0.8) { 
              // Lane 1 æ”¾æ­£ç¢ºå–®å­— (é è¨­ä½ç½®)
              spawnWord(correctWord, freeLanes[0], -50);
              
              // Lane 2 æ”¾éŒ¯èª¤å–®å­— (ä½ç½®éŒ¯é–‹ï¼Œé¿å…æ‰‹æ©Ÿç‰ˆé¢å–®å­—é‡ç–Š)
              const wrong = shuffle(allWords.filter(w => w !== correctWord))[0];
              spawnWord(wrong, freeLanes[1], -220); 
              return;
          }
      }

      // å…¶ä»–æƒ…æ³ç”Ÿæˆè»Šè¼› (ä¿æŒäº¤é€šæµé‡)
      if (freeLanes.length > 0) {
          // ç¨å¾®æ§åˆ¶ä¸€ä¸‹è»Šè¼›å¯†åº¦
          if (Math.random() < 0.7) {
            spawnTraffic(freeLanes[0]);
          }
      }
    }

    function spawnTraffic(lane) {
      const el = document.createElement('div');
      el.className = "game-object traffic-car";
      el.dataset.type = "car";
      el.dataset.speed = 5 + Math.random() * 2; 
      
      el.style.left = lane + '%';
      el.style.top = '-150px';

      const imgName = CAR_IMAGES[Math.floor(Math.random() * CAR_IMAGES.length)];
      const fallbackColor = FALLBACK_COLORS[Math.floor(Math.random() * FALLBACK_COLORS.length)];

      el.innerHTML = `
        <div class="car-body">
          <img src="${imgName}" class="car-img" onerror="this.style.display='none'; this.nextElementSibling.style.display='block';">
          <div class="fallback-rect ${fallbackColor}"></div>
        </div>
      `;
      ui.gameEntities.appendChild(el);
    }

    function spawnWord(text, lane, startY = -50) {
      const el = document.createElement('div');
      el.className = "game-object word-item";
      el.dataset.type = "word";
      el.dataset.word = text;
      el.innerText = text;
      el.dataset.speed = 5; 
      
      el.style.left = lane + '%';
      // æ”¯æ´è‡ªå®šç¾© Y è»¸èµ·å§‹ä½ç½®ï¼Œæ–¹ä¾¿éŒ¯é–‹å–®å­—
      el.style.top = startY + 'px';
      // ç‚ºäº†é‚è¼¯åˆ¤æ–·ï¼Œéœ€è¦æŠŠé€™å€‹æ•¸å€¼ä¹Ÿå¯«å…¥ dataset
      el.dataset.top = startY;

      ui.gameEntities.appendChild(el);
    }

    function endGame(isWin) {
      gameState.isRunning = false;
      clearInterval(gameState.spawnerLoop);
      cancelAnimationFrame(gameState.gameLoop);
      
      ui.trackPanel.style.cursor = 'default'; 
      ui.questionArea.classList.add('hidden');
      ui.resultScreen.classList.remove('hidden');
      ui.gameEntities.innerHTML = "";
      ui.playerCar.classList.remove('player-hit');

      if (isWin) {
        ui.resultEmoji.innerText = "ğŸ†";
        ui.resultTitle.innerText = "MISSION COMPLETE";
        ui.resultTitle.className = "text-3xl font-bold mb-2 text-yellow-400 game-font";
        ui.resultDesc.innerText = `å–®å­—æ”¶é›†å®Œæˆï¼ç¸½åˆ†ï¼š${gameState.score}`;
        ui.progressBar.style.width = "100%";
      } else {
        ui.resultEmoji.innerText = "â˜ ï¸";
        ui.resultTitle.innerText = "CRASHED";
        ui.resultTitle.className = "text-3xl font-bold mb-2 text-red-500 game-font";
        ui.resultDesc.innerText = `æŒ‘æˆ°å¤±æ•—ï¼Œè«‹å†æ¥å†å²ã€‚`;
      }
    }
  </script>
</body>
</html>